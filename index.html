<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUNTIMECHAT</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="loading-screen" class="screen active">
        <div class="logo-pulse">MH</div> <p>Loading FunTimeChat...</p>
    </div>

    <div id="app-container" style="display:none;">

        <header id="topbar">
            <div class="logo">MH</div>
            <h1 id="current-view-title">Welcome</h1>
            <div class="controls">
                <button id="theme-toggle">‚òÄÔ∏è/üåô</button>
                <button id="admin-panel-btn" style="display:none;">üîë</button>
                <img id="user-photo" src="default.png" alt="Profile" class="profile-pic" style="display:none;">
                <button id="signout-btn" style="display:none;">Logout</button>
            </div>
        </header>

        <main id="main-content">
            <div id="auth-view" class="view active">
                <h2>Sign In / Sign Up</h2>
                <div class="auth-card">
                    <button id="google-signin-btn" class="square-btn type-b">Sign in with Google</button>
                    <hr>
                    <input type="email" id="email-input" placeholder="Email">
                    <input type="password" id="password-input" placeholder="Password">
                    <button id="email-signin-btn" class="square-btn type-b">Sign In</button>
                    <button id="email-signup-btn" class="square-btn type-b">Sign Up</button>
                    <button id="forgot-password-btn">Forgot Password?</button>
                    <button id="anonymous-login-btn">Continue as Guest</button>
                </div>
            </div>

            <div id="public-chat-view" class="view" style="display:none;">
                <div class="room-selector">
                    <button class="square-btn type-b active-room">Global Chat</button>
                </div>
                <div id="messages-container" class="message-list-area">
                    </div>
                <div id="typing-indicator" class="typing-status" style="display:none;">Someone is typing...</div>
                <div class="input-area">
                    <input type="text" id="message-input" placeholder="Type a message...">
                    <input type="file" id="file-upload-input" style="display:none;">
                    <button id="upload-file-btn">üìé</button>
                    <button id="send-message-btn" class="square-btn type-b">‚û°Ô∏è</button>
                </div>
            </div>

            <div id="inbox-view" class="view" style="display:none;"><h2>Private Messages (Inbox)</h2><p>Feature implementation pending...</p></div>
            <div id="random-chat-view" class="view" style="display:none;">
                <h2>Random Chat</h2>
                <p>Click 'Start Match' to find a stranger!</p>
                <button id="start-random-match-btn" class="square-btn type-b">Start Match</button>
            </div>
            <div id="friends-view" class="view" style="display:none;"><h2>Friends & Requests</h2><p>Feature implementation pending...</p></div>
            <div id="admin-view" class="view" style="display:none;"><h2>Admin Panel</h2><p>Feature implementation pending...</p></div>
            
        </main>

        <div id="call-overlay" class="call-ui" style="display:none;">
            <p>Incoming Call...</p>
            <div id="call-controls">
                <button id="accept-call-btn" class="square-btn type-b">‚úÖ Accept</button>
                <button id="reject-call-btn" class="square-btn type-b">‚ùå Reject</button>
            </div>
        </div>

        <nav id="bottom-nav">
            <button data-view="public-chat-view">üí¨ Public</button>
            <button data-view="inbox-view">‚úâÔ∏è Inbox</button>
            <button data-view="random-chat-view">üé≤ Random</button>
            <button data-view="friends-view">üë• Friends</button>
        </nav>

        <footer id="legal-footer">
            <a href="privacy.html">Privacy Policy</a> | <a href="terms.html">Terms</a> | <a href="report.html">Report</a>
        </footer>
    </div>

    <audio id="new-message-sound" src="message.mp3" preload="auto"></audio>
    <audio id="incoming-call-ringtone" src="ringtone.mp3" preload="auto"></audio>

    <script type="module">
        // üö® STEP 1: Firebase Configuration (Your Code)
        const firebaseConfig = {
            apiKey: "AIzaSyB__tJ3sv3cB2N3vKHFCv8SYngJENQxwhY",
            authDomain: "funtimechat69-39947.firebaseapp.com",
            databaseURL: "https://funtimechat69-39947-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "funtimechat69-39947",
            storageBucket: "funtimechat69-39947.firebasestorage.app",
            messagingSenderId: "559638056734",
            appId: "1:559638056734:web:9329d2b561b6fab106830f"
        };

        // üö® STEP 2: Necessary Firebase SDK Imports (ADDED 'remove' for Random Chat)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, 
            signOut, signInAnonymously, updateProfile 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getDatabase, ref, push, onValue, serverTimestamp, query, limitToLast, set, remove, off
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // Initialize Firebase Services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Utility function to switch views
        const handleNavigation = (viewId) => {
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });
            const newView = document.getElementById(viewId);
            if(newView) {
                newView.style.display = 'block';
                document.getElementById('current-view-title').textContent = newView.querySelector('h2')?.textContent || 'FunTimeChat';
            }
        };

        // ***************************************************************
        // 2. ACCOUNT SYSTEM (AUTHENTICATION) - ACTIVE
        // ***************************************************************

        // Auth State Listener (Handles Login/Logout UI)
        onAuthStateChanged(auth, (user) => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex'; 

            const userPhotoEl = document.getElementById('user-photo');
            const signoutBtn = document.getElementById('signout-btn');

            if (user) {
                // LOGGED IN
                document.getElementById('auth-view').style.display = 'none';
                userPhotoEl.style.display = 'block';
                signoutBtn.style.display = 'block';

                userPhotoEl.src = user.photoURL || 'default.png';
                
                if(document.getElementById('public-chat-view').style.display === 'none' && document.getElementById('auth-view').style.display === 'block') {
                    handleNavigation('public-chat-view');
                }
            } else {
                // LOGGED OUT
                document.getElementById('auth-view').style.display = 'block';
                userPhotoEl.style.display = 'none';
                signoutBtn.style.display = 'none';
                
                handleNavigation('auth-view');
            }
        });
        
        // Google Sign-in
        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert("Google Sign-in failed: " + error.message);
            }
        });
        
        // Email/Password Sign-up
        document.getElementById('email-signup-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: email.split('@')[0] }); 
                alert("Sign Up successful! Logged in.");
            } catch (error) {
                alert("Sign Up failed: " + error.message);
            }
        });

        // Email/Password Sign-in
        document.getElementById('email-signin-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                alert("Sign In successful!");
            } catch (error) {
                alert("Sign In failed: " + error.message);
            }
        });

        // Anonymous Login
        document.getElementById('anonymous-login-btn').addEventListener('click', async () => {
            try {
                await signInAnonymously(auth);
                alert("Signed in as Guest.");
            } catch (error) {
                alert("Anonymous Sign-in failed: " + error.message);
            }
        });

        // Forgot Password
        document.getElementById('forgot-password-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-input').value;
            if (email) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    alert("Password reset email sent!");
                } catch (error) {
                    alert("Error sending reset email: " + error.message);
                }
            } else {
                alert("Please enter your email in the field above.");
            }
        });
        
        // Logout Button
        document.getElementById('signout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout Error:", error);
            }
        });

        // ***************************************************************
        // 3. PUBLIC CHAT SYSTEM (ACTIVE SEND/RECEIVE + SEEN TICKS)
        // ***************************************************************

        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const messagesRef = ref(db, 'public_rooms/global/messages');
        const recentMessagesQuery = query(messagesRef, limitToLast(100)); 

        // üí° FUNCTION: ‡§Æ‡•à‡§∏‡•á‡§ú ‡§ï‡•ã ‡§™‡§¢‡§º‡§®‡•á (Seen) ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ö‡§ø‡§π‡•ç‡§®‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ
        const updateMessageSeenStatus = (messageKey) => {
            const currentUser = auth.currentUser;
            if (!currentUser) return;

            const messageReadRef = ref(db, `public_rooms/global/messages/${messageKey}/reads/${currentUser.uid}`);
            set(messageReadRef, true)
                .catch(error => console.error("Error setting seen status:", error));
        };

        // Sending Message Logic
        sendMessageBtn.addEventListener('click', async () => {
            const messageText = messageInput.value.trim();
            const currentUser = auth.currentUser;

            if (messageText && currentUser) {
                const initialReads = {};
                initialReads[currentUser.uid] = true; 

                try {
                    await push(messagesRef, {
                        uid: currentUser.uid,
                        displayName: currentUser.displayName || 'Guest',
                        text: messageText,
                        timestamp: serverTimestamp(),
                        reads: initialReads, 
                    });
                    messageInput.value = ''; 
                    document.getElementById('new-message-sound').play(); 
                } catch (e) {
                    console.error("Error sending message: ", e);
                }
            }
        });

        // Receiving Messages Logic (Real-time updates + Seen Status)
        onValue(recentMessagesQuery, (snapshot) => {
            messagesContainer.innerHTML = ''; 
            const currentUserUid = auth.currentUser?.uid;

            snapshot.forEach((childSnapshot) => {
                const message = childSnapshot.val();
                const key = childSnapshot.key;
                
                // --- SEEN LOGIC CALCULATION ---
                const reads = message.reads || {};
                const allUids = Object.keys(reads);
                
                let seenStatus = 'delivered'; 
                let seenCount = allUids.length - 1; 

                if (message.uid === currentUserUid) {
                    // Sender's view
                    if (seenCount >= 1) {
                        seenStatus = 'seen'; 
                    } 
                } else {
                    // Receiver's view
                    seenStatus = 'received';
                    
                    if (!reads[currentUserUid]) {
                        // Mark as read after a short delay
                        setTimeout(() => updateMessageSeenStatus(key), 500);
                    }
                }
                // ------------------------------

                const messageElement = document.createElement('div');
                messageElement.className = `message-card ${seenStatus}`; 
                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="user-name">${message.displayName || 'Anonymous'}</span>
                        <span class="timestamp">${new Date(message.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <p class="message-text">${message.text}</p>
                    <div class="message-status-ticks">
                        ${message.uid === currentUserUid ? (seenStatus === 'seen' ? '‚úîÔ∏è‚úîÔ∏è' : '‚úîÔ∏è') : ''}
                    </div>
                `;
                messageElement.dataset.key = key; 
                messagesContainer.appendChild(messageElement);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
        
        // ***************************************************************
        // 5. RANDOM CHAT SYSTEM (ACTIVE LOGIC)
        // ***************************************************************

        const randomChatBtn = document.querySelector('#bottom-nav button[data-view="random-chat-view"]');
        const randomChatView = document.getElementById('random-chat-view');
        let currentMatchListener = null; // To hold the listener for the current user's match

        // üí° NEW FUNCTION: ‡§®‡§Ø‡§æ ‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§ü ‡§ö‡•à‡§ü ‡§∞‡•Ç‡§Æ ‡§¨‡§®‡§æ‡§®‡§æ
        const createNewRandomChat = (user1Uid, user2Uid) => {
            // ‡§ö‡•à‡§ü ID ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¶‡•ã‡§®‡•ã‡§Ç UIDs ‡§ï‡•ã ‡§∏‡•â‡§∞‡•ç‡§ü ‡§ï‡§∞‡§ï‡•á ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
            const chatID = [user1Uid, user2Uid].sort().join('_');
            const chatRef = ref(db, `private_chats/${chatID}`);

            // ‡§ö‡•à‡§ü ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
            set(chatRef, {
                participants: {
                    [user1Uid]: { displayName: auth.currentUser.displayName || 'User' },
                    [user2Uid]: { displayName: 'Stranger' } 
                },
                status: 'active',
                createdAt: serverTimestamp()
            })
            .then(() => {
                alert(`Match Found! Chat ID: ${chatID}. (Next step: implement Private Chat View)`);
                // Match Found ‡§π‡•ã‡§®‡•á ‡§™‡§∞, Random View ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ Public Chat View ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Å
                randomChatView.innerHTML = `<h2>Random Chat</h2><p>Match Found! Start chatting in your Inbox view.</p><button id="start-random-match-btn" class="square-btn type-b">Start New Match</button>`;
                handleNavigation('inbox-view'); // ‡§Ö‡§¨ Inbox ‡§™‡§∞ ‡§∞‡•Ä‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç
            })
            .catch(error => console.error("Error creating chat:", error));
            
            // Queue ‡§∏‡•á ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§Ø‡•Ç‡§ú‡§º‡§∞‡•ç‡§∏ ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç 
            remove(ref(db, `matchQueue/${user1Uid}`));
            remove(ref(db, `matchQueue/${user2Uid}`));
        };


        // üí° NEW FUNCTION: ‡§Æ‡•à‡§ö Queue ‡§Æ‡•á‡§Ç ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡•ã ‡§°‡§æ‡§≤‡§®‡§æ ‡§î‡§∞ ‡§Æ‡•à‡§ö ‡§¢‡•Ç‡§Å‡§¢‡§®‡§æ
        const startRandomMatchmaking = async () => {
            const currentUser = auth.currentUser;
            if (!currentUser || currentUser.isAnonymous) {
                alert("Please sign in with a permanent account to start Random Chat.");
                return;
            }

            // 1. Loading Screen ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å ‡§î‡§∞ 'Random Chat' ‡§µ‡•ç‡§Ø‡•Ç ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Å
            randomChatView.innerHTML = `<h2>Searching for a Match...</h2><p>Please wait while we connect you with a stranger.</p><button id="cancel-match-btn" class="square-btn type-b">Cancel Matchmaking</button>`;
            handleNavigation('random-chat-view');

            const queueRef = ref(db, 'matchQueue');

            // 2. Queue ‡§Æ‡•á‡§Ç ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡•ã ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
            await set(ref(db, `matchQueue/${currentUser.uid}`), {
                displayName: currentUser.displayName || 'Stranger',
                timestamp: serverTimestamp()
            });
            
            // Cancel ‡§¨‡§ü‡§® ‡§≤‡•â‡§ú‡§ø‡§ï
            document.getElementById('cancel-match-btn').addEventListener('click', () => {
                remove(ref(db, `matchQueue/${currentUser.uid}`));
                if (currentMatchListener) {
                    off(currentMatchListener); // Listener ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç
                }
                randomChatView.innerHTML = `<h2>Random Chat</h2><p>Matchmaking cancelled. Click 'Start Match' to try again.</p><button id="start-random-match-btn" class="square-btn type-b">Start Match</button>`;
                // Cancel ‡§ï‡•á ‡§¨‡§æ‡§¶ Start Match ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§´‡§ø‡§∞ ‡§∏‡•á listener ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                document.getElementById('start-random-match-btn').addEventListener('click', startRandomMatchmaking);
            });

            // 3. ‡§Æ‡•à‡§ö ‡§¢‡•Ç‡§Å‡§¢‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è Queue ‡§ï‡•ã ‡§™‡§¢‡§º‡•á‡§Ç
            const findMatch = onValue(queueRef, (snapshot) => {
                const queue = snapshot.val();
                if (!queue) return;
                
                const uidsInQueue = Object.keys(queue);
                
                // ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø Queue ‡§Æ‡•á‡§Ç ‡§ñ‡•Å‡§¶ ‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ ‡§ï‡•ã‡§à ‡§î‡§∞ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§π‡•à ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç
                if (uidsInQueue.length >= 2) {
                    // Random Match Logic: ‡§™‡§π‡§≤‡•á ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡•ã ‡§õ‡•ã‡§°‡§º ‡§ï‡§∞ ‡§¨‡§æ‡§ï‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§¢‡•Ç‡§Å‡§¢‡•á
                    const potentialMatchUid = uidsInQueue.find(uid => uid !== currentUser.uid);

                    if (potentialMatchUid) {
                        // ‡§Æ‡•à‡§ö ‡§Æ‡§ø‡§≤ ‡§ó‡§Ø‡§æ! listener ‡§ï‡•ã ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç 
                        off(findMatch);
                        
                        // 4. ‡§®‡§Ø‡§æ ‡§ö‡•à‡§ü ‡§∞‡•Ç‡§Æ ‡§¨‡§®‡§æ‡§è‡§Å
                        createNewRandomChat(currentUser.uid, potentialMatchUid);
                    }
                }
            });

            currentMatchListener = findMatch; // listener ‡§ï‡•ã ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§¨‡§Ç‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç (cancel ‡§¨‡§ü‡§® ‡§™‡§∞)
        };

        // 5. Bottom Nav Button ‡§î‡§∞ Start Match ‡§¨‡§ü‡§® ‡§™‡§∞ Listener ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
        randomChatBtn.addEventListener('click', () => {
            if (auth.currentUser) {
                // ‡§∏‡•Ä‡§ß‡•á Matchmaking ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç ‡§ú‡§¨ Random ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§π‡•ã
                startRandomMatchmaking();
            } else {
                alert("Please sign in to use Random Chat.");
                handleNavigation('auth-view');
            }
        });

        // 6. Random Chat View ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ Placeholder ‡§¨‡§ü‡§® ‡§™‡§∞ Listener ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (‡§ú‡§¨ Match Cancel ‡§π‡•ã ‡§Ø‡§æ ‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞ View ‡§π‡•ã)
        // ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø 'Start Match' ‡§¨‡§ü‡§® ‡§π‡§Æ‡•á‡§∂‡§æ ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á
        document.getElementById('random-chat-view').addEventListener('click', (e) => {
            if (e.target.id === 'start-random-match-btn') {
                startRandomMatchmaking();
            }
        });
        
        // ***************************************************************
        // UI AND NAVIGATION (Point 1)
        // ***************************************************************

        // Bottom Navigation Handler
        document.getElementById('bottom-nav').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.view) {
                if (auth.currentUser || e.target.dataset.view === 'auth-view') {
                    handleNavigation(e.target.dataset.view);
                } else {
                    alert("Please sign in first!");
                }
            }
        });
        
        // Dark/Light Toggle Placeholder
        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });

        // ***************************************************************
        // PLACEHOLDERS FOR ADVANCED FEATURES (4, 6, 7, 8, 9, 10)
        // ***************************************************************
        
        // Note: Random Chat (Point 5) logic is now fully implemented above.

    </script>
</body>
</html>
