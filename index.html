<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUNTIMECHAT</title>
    <link rel="stylesheet" href="style.css"> 
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    </head>
<body>

    <div id="loading-screen" class="screen active">
        <div class="logo-pulse">MH</div> <p>Loading FunTimeChat...</p>
    </div>

    <div id="app-container" style="display:none;">

        <header id="topbar">
            <div class="logo">MH</div>
            <h1 id="current-view-title">Welcome</h1>
            <div class="controls">
                <button id="theme-toggle">‚òÄÔ∏è/üåô</button>
                <button id="admin-panel-btn" style="display:none;">üîë Admin</button>
                <img id="user-photo" src="default.png" alt="Profile" class="profile-pic" style="display:none;">
                <button id="signout-btn" style="display:none;">Logout</button>
            </div>
        </header>

        <main id="main-content">
            
            <div id="auth-view" class="view active">
                <h2>Sign In / Sign Up</h2>
                <div class="auth-card">
                    <button id="google-signin-btn" class="square-btn type-b">Sign in with Google</button>
                    <hr>
                    <input type="email" id="email-input" placeholder="Email">
                    <input type="password" id="password-input" placeholder="Password">
                    <button id="signup-btn" class="square-btn type-b">Sign Up</button>
                    <button id="signin-btn" class="square-btn">Sign In</button>
                    <hr>
                    <button id="guest-login-btn" class="square-btn">Continue as Guest</button>
                </div>
            </div>

            <div id="public-chat-view" class="view" style="display:none;">
                <div class="room-selector">
                    <button id="global-chat-btn" class="square-btn type-b">Global Chat</button>
                </div>
                
                <div id="public-messages" class="message-list-area">
                    </div>
                
                <div class="typing-status" id="public-typing-status"></div>

                <div class="input-area">
                    <input type="text" id="public-message-input" placeholder="Type a public message...">
                    <button id="public-send-btn" class="square-btn type-b">Send</button>
                </div>
            </div>

            <div id="inbox-view" class="view" style="display:none;">
                <h2>Private Inbox</h2>
                <div id="chat-list-container">
                    </div>
                <hr>
                <div style="text-align: center; margin-top: 15px;">
                    <button id="start-random-chat-btn" class="square-btn type-b">Start Random Chat üé≤</button>
                    <p id="random-match-status" style="font-style: italic; margin-top: 10px;"></p>
                </div>
            </div>

            <div id="private-chat-room" class="view" style="display:none;">
                <h2 id="private-chat-header"></h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button id="start-video-call-btn" class="square-btn type-b">üìû Video Call</button>
                    <button id="start-audio-call-btn" class="square-btn">üé§ Audio Call</button>
                </div>

                <div id="private-messages" class="message-list-area">
                    </div>
                
                <div class="typing-status" id="private-typing-status"></div>
                
                <div class="input-area">
                    <button id="emoji-toggle-btn" class="square-btn">üòä</button>
                    <div class="emoji-picker" id="emoji-picker" style="display:none;">
                        </div>
                    <input type="text" id="private-message-input" placeholder="Type a private message...">
                    <button id="private-send-btn" class="square-btn type-b">Send</button>
                </div>
            </div>

            <div id="friends-view" class="view" style="display:none;">
                <h2>Friends & Search</h2>
                <div class="search-area">
                    <input type="text" id="user-search-input" placeholder="Search users by name...">
                    <button id="search-users-btn" class="square-btn type-b">Search</button>
                </div>
                
                <h3 style="margin-top: 20px;">Search Results:</h3>
                <div id="search-results-container">
                    </div>

                <h3 style="margin-top: 20px;">Pending Requests:</h3>
                <div id="requests-container">
                    </div>

                <h3 style="margin-top: 20px;">My Friends:</h3>
                <div id="friends-list-container">
                    </div>
            </div>
            
            <div id="admin-panel-view" class="view" style="display:none;">
                <h2>Admin Control Panel</h2>
                
                <div class="admin-panel-tabs">
                    <button data-tab="admin-users-tab" class="square-btn active-tab">Users</button>
                    <button data-tab="admin-messages-tab" class="square-btn">Public Messages</button>
                </div>
                
                <div id="admin-users-tab" class="admin-tab-content">
                    <h3>User List and Roles</h3>
                    <div id="admin-users-list">
                        <p>Loading users...</p>
                    </div>
                </div>

                <div id="admin-messages-tab" class="admin-tab-content" style="display:none;">
                    <h3>Public Chat Messages</h3>
                    <div id="admin-public-messages">
                        <p>Loading public messages...</p>
                    </div>
                </div>

            </div>

        </main>
        
        <nav id="bottom-nav">
            <button data-view="public-chat-view">üåé Chat</button>
            <button data-view="inbox-view">‚úâÔ∏è Inbox</button>
            <button data-view="friends-view">üë• Friends</button>
        </nav>
        
        <footer id="legal-footer">
            <a href="privacy.html" target="_blank">Privacy</a> | 
            <a href="terms.html" target="_blank">Terms</a> | 
            <a href="report.html" target="_blank">Report</a>
        </footer>

    </div>
    
    <div id="call-ui" class="call-ui" style="display: none;">
        <h2 id="call-status-text">Connecting...</h2>
        
        <div style="position: relative;">
             <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" muted autoplay playsinline style="width: 120px; height: 90px; position: absolute; top: 10px; right: 10px; border-radius: 5px;"></video>
        </div>
       
        <div id="call-controls">
            <button id="toggle-video-btn" class="square-btn" style="background-color: orange;">üìπ Toggle Video</button>
            <button id="toggle-audio-btn" class="square-btn" style="background-color: orange;">üéôÔ∏è Toggle Audio</button>
            <button id="end-call-btn" class="square-btn" style="background-color: red;">Hang Up üìû</button>
        </div>
    </div>


    <script>
        // ***************************************************************
        // I. FIREBASE SETUP
        // ***************************************************************

        // Yahan apni Firebase configuration dalein!
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_CONFIG",
            authDomain: "YOUR_FIREBASE_CONFIG",
            databaseURL: "YOUR_FIREBASE_CONFIG",
            projectId: "YOUR_FIREBASE_CONFIG",
            // storageBucket: "YOUR_FIREBASE_CONFIG", // Storage hata diya gaya hai
            messagingSenderId: "YOUR_FIREBASE_CONFIG",
            appId: "YOUR_FIREBASE_CONFIG"
        };

        // Firebase ko initialize karein
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Database References
        const usersRef = database.ref('users');
        const publicMessagesRef = database.ref('public_messages');
        const friendsRef = database.ref('friends');
        const requestsRef = database.ref('requests');
        const typingRef = database.ref('typing_status');
        const randomMatchRef = database.ref('random_match');
        const callsRef = database.ref('calls');
        
        // ***************************************************************
        // II. GLOBAL STATE
        // ***************************************************************
        let currentUser = null;
        let currentView = 'auth-view';
        let privateChatId = null; 
        let privateChatRecipient = null;
        let isRandomMatching = false;
        let isAdmin = false;

        // Sounds
        const messageSound = new Audio('message.mp3');
        const ringtone = new Audio('ringtone.mp3');
        ringtone.loop = true;

        // ***************************************************************
        // III. UI UTILITIES
        // ***************************************************************

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });
            document.getElementById(viewId).style.display = 'flex';
            currentView = viewId;
            updateTitle(viewId);
        }

        function updateTitle(viewId) {
            const titleElement = document.getElementById('current-view-title');
            switch (viewId) {
                case 'public-chat-view': titleElement.textContent = 'Global Chat'; break;
                case 'inbox-view': titleElement.textContent = 'Inbox / Random Chat'; break;
                case 'friends-view': titleElement.textContent = 'Friends & Search'; break;
                case 'private-chat-room': 
                    if (privateChatRecipient) {
                        titleElement.textContent = `Chatting with ${privateChatRecipient.name}`;
                    } else {
                        titleElement.textContent = 'Private Chat';
                    }
                    break;
                case 'admin-panel-view': titleElement.textContent = 'Admin Panel'; break;
                default: titleElement.textContent = 'Welcome'; break;
            }
        }

        function handleNavigation(viewId) {
            if (viewId === 'private-chat-room' && !privateChatId) return; // Prevent direct access
            
            // Cleanup on view change
            if (currentView === 'private-chat-room') {
                stopTypingIndicator(privateChatId);
            }
            if (isRandomMatching) {
                cancelRandomMatch();
            }

            // Hide Admin Panel button if navigating away from Admin
            if (viewId !== 'admin-panel-view') {
                document.getElementById('admin-panel-btn').style.display = isAdmin ? 'block' : 'none';
            }

            showView(viewId);
        }
        
        function createMessageCard(message, isOutgoing, messageId = null, showName = true, isAdminView = false) {
            const card = document.createElement('div');
            card.className = `message-card ${isOutgoing ? 'outgoing' : 'incoming'}`;
            card.dataset.messageId = messageId;

            let nameHtml = showName ? `<span class="message-sender">${message.senderName || 'Guest'}</span>` : '';
            let timeHtml = `<span class="message-time">${new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>`;
            
            let header = `<div class="message-header">${nameHtml}${timeHtml}</div>`;
            
            let status = isOutgoing ? `<span class="message-status-ticks" title="Seen">‚úì‚úì</span>` : ''; 
            
            let text = `<p class="message-text">${message.text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>`;
            
            let adminControls = '';
            if (isAdminView && messageId && currentUser && isAdmin) {
                 adminControls = `
                    <div style="margin-top: 5px;">
                        <button onclick="deletePublicMessage('${messageId}')" class="square-btn" style="background-color: #dc3545; font-size: 0.7em;">Delete</button>
                    </div>
                `;
            }

            card.innerHTML = header + text + status + adminControls;
            return card;
        }

        // ***************************************************************
        // IV. FIREBASE AUTHENTICATION
        // ***************************************************************

        auth.onAuthStateChanged(async (user) => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';

            if (user) {
                currentUser = user;
                
                // User Data ko database mein save ya update karein
                await saveUserData(user);
                
                // Check Admin Status
                isAdmin = await checkAdminStatus(user.uid);
                
                document.getElementById('user-photo').src = user.photoURL || 'default.png';
                document.getElementById('user-photo').style.display = 'block';
                document.getElementById('signout-btn').style.display = 'block';
                
                if (isAdmin) {
                    document.getElementById('admin-panel-btn').style.display = 'block';
                }

                // Initial view
                handleNavigation('public-chat-view');

                // User ko online set karein
                setUserOnlineStatus(user.uid, true);

            } else {
                // Logged out
                currentUser = null;
                isAdmin = false;
                document.getElementById('user-photo').style.display = 'none';
                document.getElementById('signout-btn').style.display = 'none';
                document.getElementById('admin-panel-btn').style.display = 'none';
                showView('auth-view');
            }
        });

        // Google Sign-in
        document.getElementById('google-signin-btn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider);
        });
        
        // Email Sign-up
        document.getElementById('signup-btn').addEventListener('click', () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => alert('Sign Up Successful!'))
                .catch(error => alert(error.message));
        });

        // Email Sign-in
        document.getElementById('signin-btn').addEventListener('click', () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => alert(error.message));
        });

        // Guest Login
        document.getElementById('guest-login-btn').addEventListener('click', () => {
            auth.signInAnonymously()
                .then(() => alert('Signed in as Guest. Please note, guest data is not permanently stored.'))
                .catch(error => alert(error.message));
        });

        // Logout
        document.getElementById('signout-btn').addEventListener('click', () => {
            if (currentUser) {
                 setUserOnlineStatus(currentUser.uid, false);
            }
            auth.signOut();
        });
        
        // User Data aur Online Status
        function saveUserData(user) {
            let userData = {
                uid: user.uid,
                email: user.email || 'guest',
                name: user.displayName || user.email?.split('@')[0] || `Guest-${user.uid.substring(0, 4)}`,
                photoURL: user.photoURL || 'default.png',
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            };
            // Set only if user does not exist or if display name/photo is new
            usersRef.child(user.uid).update(userData);
            return userData;
        }

        function setUserOnlineStatus(uid, isOnline) {
            if (uid) {
                usersRef.child(uid).child('isOnline').set(isOnline);
                if (isOnline) {
                     // Disconnect hook for setting offline when browser closes
                    usersRef.child(uid).child('isOnline').onDisconnect().set(false);
                    usersRef.child(uid).child('lastSeen').onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                }
            }
        }
        
        async function checkAdminStatus(uid) {
             const snapshot = await usersRef.child(uid).once('value');
             return snapshot.val()?.role === 'admin';
        }


        // ***************************************************************
        // V. PUBLIC CHAT LOGIC
        // ***************************************************************
        
        // Message bhejna
        document.getElementById('public-send-btn').addEventListener('click', () => {
            if (!currentUser) {
                alert("Please sign in to chat.");
                return;
            }
            const input = document.getElementById('public-message-input');
            const text = input.value.trim();
            if (text === '') return;

            const messageData = {
                senderId: currentUser.uid,
                senderName: currentUser.displayName || currentUser.email?.split('@')[0] || 'Guest',
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            publicMessagesRef.push(messageData);
            input.value = '';
            stopTypingIndicator('public');
        });

        // Messages ko display karna
        publicMessagesRef.limitToLast(50).on('child_added', (snapshot) => {
            const message = snapshot.val();
            const messageId = snapshot.key;
            const isOutgoing = message.senderId === currentUser?.uid;
            
            // Public messages mein name hamesha dikhao
            const card = createMessageCard(message, isOutgoing, messageId, true, false); 
            
            const list = document.getElementById('public-messages');
            list.appendChild(card);
            list.scrollTop = list.scrollHeight;
            
            // Sound play karein agar message incoming ho
            if (!isOutgoing && currentView !== 'public-chat-view') {
                 messageSound.play().catch(e => console.log("Sound error:", e));
            }
        });
        
        // Public Typing Indicator Logic
        let publicTypingTimeout = null;
        
        document.getElementById('public-message-input').addEventListener('input', () => {
            if (!currentUser) return;
            startTypingIndicator('public');
        });
        
        function startTypingIndicator(chatId) {
            const path = chatId === 'public' ? 'public' : `private/${chatId}`;
            typingRef.child(path).child(currentUser.uid).set(currentUser.displayName || 'User');

            if (publicTypingTimeout) {
                clearTimeout(publicTypingTimeout);
            }
            publicTypingTimeout = setTimeout(() => {
                stopTypingIndicator(chatId);
            }, 3000); // 3 seconds baad band kar do
        }

        function stopTypingIndicator(chatId) {
            const path = chatId === 'public' ? 'public' : `private/${chatId}`;
             typingRef.child(path).child(currentUser.uid).remove();
        }

        // Public Typing Indicator Listener
        typingRef.child('public').on('value', (snapshot) => {
            const typers = snapshot.val();
            const statusElement = document.getElementById('public-typing-status');
            
            if (!typers) {
                statusElement.textContent = '';
                return;
            }
            
            const typingUsers = Object.values(typers).filter(name => name !== (currentUser.displayName || 'User'));
            
            if (typingUsers.length > 0) {
                if (typingUsers.length === 1) {
                    statusElement.textContent = `${typingUsers[0]} is typing...`;
                } else if (typingUsers.length <= 3) {
                    statusElement.textContent = `${typingUsers.join(', ')} are typing...`;
                } else {
                    statusElement.textContent = `Multiple users are typing...`;
                }
            } else {
                statusElement.textContent = '';
            }
        });


        // ***************************************************************
        // VI. FRIENDS AND INBOX LOGIC
        // ***************************************************************

        // Friend Request Bhejna
        window.sendFriendRequest = (recipientUid) => {
            if (!currentUser || currentUser.uid === recipientUid) return;

            // Sender (currentUser) se request bhejna
            requestsRef.child(recipientUid).child(currentUser.uid).set({
                senderName: currentUser.displayName || 'User',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => alert(`Friend request sent to ${recipientUid.substring(0, 6)}`))
            .catch(e => alert("Error sending request: " + e.message));
        };
        
        // Request Accept/Reject
        window.handleFriendRequest = (senderUid, action) => {
            if (!currentUser) return;
            
            if (action === 'accept') {
                // Dono taraf friend add karein
                friendsRef.child(currentUser.uid).child(senderUid).set(true);
                friendsRef.child(senderUid).child(currentUser.uid).set(true);
                
                // Chat room banayein (UIDs ko alphabetically sort karke)
                const chatId = [currentUser.uid, senderUid].sort().join('_');
                database.ref(`chats/${chatId}`).child('metadata').set({
                    user1: currentUser.uid,
                    user2: senderUid,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                alert('Friend added and private chat started!');
            }
            
            // Request ko delete karein
            requestsRef.child(currentUser.uid).child(senderUid).remove();
            loadFriendRequests(); // UI update karein
        };
        
        // Friends List aur Request ko load karna
        function loadFriendRequests() {
            if (!currentUser) return;
            const requestsList = document.getElementById('requests-container');
            requestsList.innerHTML = '';
            
            requestsRef.child(currentUser.uid).on('value', (snapshot) => {
                requestsList.innerHTML = '';
                const requests = snapshot.val();
                if (!requests) {
                    requestsList.innerHTML = '<p>No pending friend requests.</p>';
                    return;
                }
                
                Object.keys(requests).forEach(senderUid => {
                    const request = requests[senderUid];
                    const item = document.createElement('div');
                    item.className = 'chat-list-item';
                    item.innerHTML = `
                        <div>
                            <h3>Friend Request from: ${request.senderName}</h3>
                            <p>${new Date(request.timestamp).toLocaleDateString()}</p>
                        </div>
                        <div>
                            <button onclick="handleFriendRequest('${senderUid}', 'accept')" class="square-btn" style="background-color: green; margin-right: 5px;">Accept</button>
                            <button onclick="handleFriendRequest('${senderUid}', 'reject')" class="square-btn" style="background-color: #dc3545;">Reject</button>
                        </div>
                    `;
                    requestsList.appendChild(item);
                });
            });
        }
        
        // Friends List ko load karna
        function loadFriendsList() {
            if (!currentUser) return;
            const friendsListContainer = document.getElementById('friends-list-container');
            friendsListContainer.innerHTML = '';
            
            friendsRef.child(currentUser.uid).on('value', (snapshot) => {
                friendsListContainer.innerHTML = '';
                const friends = snapshot.val();
                if (!friends) {
                    friendsListContainer.innerHTML = '<p>No friends added yet.</p>';
                    return;
                }
                
                Object.keys(friends).forEach(friendUid => {
                    // Friend ki details fetch karein
                    usersRef.child(friendUid).once('value', (userSnapshot) => {
                        const friendData = userSnapshot.val();
                        if (friendData) {
                            const item = document.createElement('div');
                            item.className = 'chat-list-item';
                            item.innerHTML = `
                                <div>
                                    <h3>${friendData.name}</h3>
                                    <p style="color: ${friendData.isOnline ? 'green' : 'gray'};">${friendData.isOnline ? 'Online' : 'Offline'}</p>
                                </div>
                                <button onclick="startPrivateChat('${friendUid}', '${friendData.name}')" class="square-btn type-b">Message</button>
                            `;
                            friendsListContainer.appendChild(item);
                        }
                    });
                });
            });
        }
        
        // Search Logic
        document.getElementById('search-users-btn').addEventListener('click', async () => {
            const query = document.getElementById('user-search-input').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('search-results-container');
            resultsContainer.innerHTML = '';

            if (query.length < 3) {
                resultsContainer.innerHTML = '<p>Enter at least 3 characters to search.</p>';
                return;
            }
            
            // Poore users ko fetch karke client-side filtering karein
            const snapshot = await usersRef.once('value');
            const allUsers = snapshot.val();
            
            if (allUsers) {
                Object.keys(allUsers).forEach(uid => {
                    const userData = allUsers[uid];
                    if (uid !== currentUser.uid && userData.name.toLowerCase().includes(query)) {
                        const item = document.createElement('div');
                        item.className = 'chat-list-item';
                        item.innerHTML = `
                            <div>
                                <h3>${userData.name}</h3>
                                <p>${userData.email}</p>
                            </div>
                            <button onclick="sendFriendRequest('${uid}')" class="square-btn">Add Friend</button>
                        `;
                        resultsContainer.appendChild(item);
                    }
                });
            }
            if (resultsContainer.childElementCount === 0) {
                 resultsContainer.innerHTML = '<p>No users found matching your search.</p>';
            }
        });
        
        // ***************************************************************
        // VII. INBOX AND PRIVATE CHAT LOGIC
        // ***************************************************************

        // Private Chat Shuru Karna
        window.startPrivateChat = (recipientUid, recipientName) => {
            if (!currentUser) return;
            
            // Chat ID banane ke liye UIDs ko sort karein
            const chatUids = [currentUser.uid, recipientUid].sort();
            privateChatId = chatUids.join('_');
            privateChatRecipient = { uid: recipientUid, name: recipientName };
            
            // Header aur views set karein
            document.getElementById('private-chat-header').textContent = `Chatting with ${recipientName}`;
            document.getElementById('private-messages').innerHTML = ''; // Purane messages clear karein
            handleNavigation('private-chat-room');
            
            // Messages load karein
            loadPrivateMessages(privateChatId);
        };
        
        function loadPrivateMessages(chatId) {
            database.ref(`chats/${chatId}/messages`).limitToLast(50).on('child_added', (snapshot) => {
                const message = snapshot.val();
                const messageId = snapshot.key;
                const list = document.getElementById('private-messages');
                
                const isOutgoing = message.senderId === currentUser.uid;
                // Private chat mein sender name nahi dikhate agar woh outgoing ho
                const card = createMessageCard(message, isOutgoing, messageId, !isOutgoing); 
                
                list.appendChild(card);
                list.scrollTop = list.scrollHeight;
                 
                 // Sound play karein agar message incoming ho aur hum chat mein na hon
                if (!isOutgoing && currentView !== 'private-chat-room') {
                    messageSound.play().catch(e => console.log("Sound error:", e));
                }
            });
            
            // Private Chat Typing Indicator Listener
            typingRef.child(`private/${chatId}`).on('value', (snapshot) => {
                const typers = snapshot.val();
                const statusElement = document.getElementById('private-typing-status');
                
                if (!typers || !privateChatRecipient) {
                    statusElement.textContent = '';
                    return;
                }
                
                const isRecipientTyping = typers[privateChatRecipient.uid];
                
                if (isRecipientTyping) {
                    statusElement.textContent = `${privateChatRecipient.name} is typing...`;
                } else {
                    statusElement.textContent = '';
                }
            });
        }
        
        // Private Message Bhejna
        document.getElementById('private-send-btn').addEventListener('click', () => {
            if (!currentUser || !privateChatId) return;
            
            const input = document.getElementById('private-message-input');
            const text = input.value.trim();
            if (text === '') return;
            
            const messageData = {
                senderId: currentUser.uid,
                senderName: currentUser.displayName || 'User',
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref(`chats/${privateChatId}/messages`).push(messageData);
            input.value = '';
            stopTypingIndicator(privateChatId);
        });

        // Private Chat Typing Indicator
        let privateTypingTimeout = null;
        
        document.getElementById('private-message-input').addEventListener('input', () => {
            if (!currentUser || !privateChatId) return;
            startTypingIndicator(privateChatId);
        });
        
        // ***************************************************************
        // VIII. RANDOM CHAT LOGIC
        // ***************************************************************
        
        document.getElementById('start-random-chat-btn').addEventListener('click', () => {
            if (!currentUser) {
                alert("Please sign in to start a random chat.");
                return;
            }
            if (isRandomMatching) {
                cancelRandomMatch();
            } else {
                startRandomMatch();
            }
        });

        async function startRandomMatch() {
            isRandomMatching = true;
            const statusElement = document.getElementById('random-match-status');
            statusElement.textContent = 'Searching for a match... ‚è≥';
            document.getElementById('start-random-chat-btn').textContent = 'Cancel Match';

            const snapshot = await randomMatchRef.once('value');
            const queue = snapshot.val();

            if (queue && Object.keys(queue).length > 0) {
                // Pehla user queue se nikaalo
                const partnerUid = Object.keys(queue)[0];
                if (partnerUid === currentUser.uid) {
                    // Khud se match na karein
                    randomMatchRef.child(currentUser.uid).set(currentUser.displayName);
                    statusElement.textContent = 'Waiting for another user...';
                    return;
                }
                
                // Match mil gaya!
                randomMatchRef.child(partnerUid).remove();
                
                // Partner ki details fetch karein
                const partnerSnapshot = await usersRef.child(partnerUid).once('value');
                const partnerData = partnerSnapshot.val();

                if (partnerData) {
                    // Chat shuru karein jaise friend chat karte hain
                    startPrivateChat(partnerUid, partnerData.name);
                    statusElement.textContent = `Matched with ${partnerData.name}!`;
                } else {
                     statusElement.textContent = 'Error finding partner details, trying again...';
                     isRandomMatching = false;
                     startRandomMatch(); // Retry
                }

            } else {
                // Queue mein shamil ho jao
                randomMatchRef.child(currentUser.uid).set(currentUser.displayName);
                statusElement.textContent = 'Waiting for another user...';
                
                // OnDisconnect hook
                randomMatchRef.child(currentUser.uid).onDisconnect().remove();
            }
        }

        function cancelRandomMatch() {
            isRandomMatching = false;
            randomMatchRef.child(currentUser.uid).remove();
            document.getElementById('random-match-status').textContent = '';
            document.getElementById('start-random-chat-btn').textContent = 'Start Random Chat üé≤';
        }
        
        // Agar user disconnect ho jaaye toh queue se hata do
        if (currentUser) {
             randomMatchRef.child(currentUser.uid).onDisconnect().remove();
        }

        // ***************************************************************
        // IX. WebRTC CALL LOGIC (Simple Implementation)
        // ***************************************************************
        
        let localStream = null;
        let peerConnection = null;
        let callId = null;
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        document.getElementById('start-video-call-btn').addEventListener('click', () => initiateCall('video'));
        document.getElementById('start-audio-call-btn').addEventListener('click', () => initiateCall('audio'));
        document.getElementById('end-call-btn').addEventListener('click', endCall);
        
        // Video/Audio Toggles
        document.getElementById('toggle-video-btn').addEventListener('click', () => {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                document.getElementById('toggle-video-btn').textContent = videoTrack.enabled ? 'üìπ Video ON' : 'üìπ Video OFF';
            }
        });
        document.getElementById('toggle-audio-btn').addEventListener('click', () => {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                document.getElementById('toggle-audio-btn').textContent = audioTrack.enabled ? 'üéôÔ∏è Audio ON' : 'üéôÔ∏è Audio OFF';
            }
        });


        async function initiateCall(type) {
            if (!privateChatRecipient || !currentUser) return;
            
            callId = [currentUser.uid, privateChatRecipient.uid].sort().join('_');
            
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('call-status-text').textContent = `Calling ${privateChatRecipient.name}...`;

            try {
                // Media access lena
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: type === 'video', 
                    audio: true 
                });
                document.getElementById('local-video').srcObject = localStream;
                document.getElementById('local-video').style.display = type === 'video' ? 'block' : 'none';
                
                // PC banana
                peerConnection = new RTCPeerConnection(configuration);
                setupPeerConnectionListeners();
                
                // Tracks add karna
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                
                // Offer banana
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Offer ko database mein save karna
                callsRef.child(callId).set({
                    callerId: currentUser.uid,
                    recipientId: privateChatRecipient.uid,
                    offer: {
                        type: offer.type,
                        sdp: offer.sdp
                    },
                    callType: type,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Cleanup on disconnect
                callsRef.child(callId).onDisconnect().remove();
                
                // ICE candidates bhejna
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        callsRef.child(callId).child('candidates').child(currentUser.uid).push(event.candidate.toJSON());
                    }
                };

            } catch (error) {
                console.error("Error initiating call:", error);
                alert("Could not start call. Check camera/mic permissions.");
                endCall();
            }
        }
        
        function setupPeerConnectionListeners() {
            // Remote track aane par
            peerConnection.ontrack = (event) => {
                document.getElementById('remote-video').srcObject = event.streams[0];
                document.getElementById('remote-video').style.display = 'block';
                document.getElementById('call-status-text').textContent = "Connected";
            };
            
            // Call events sunna (hang up, candidates, answer)
            listenForCallUpdates();
        }

        function endCall() {
            if (ringtone) ringtone.pause();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (callId) {
                callsRef.child(callId).remove();
                callId = null;
            }
            document.getElementById('call-ui').style.display = 'none';
        }
        
        // Incoming Call Listener
        if (currentUser) {
            callsRef.orderByChild('recipientId').equalTo(currentUser.uid).on('child_added', (snapshot) => {
                const callData = snapshot.val();
                const incomingCallId = snapshot.key;
                
                if (callData.callerId !== currentUser.uid) {
                    handleIncomingCall(incomingCallId, callData);
                }
            });
        }
        
        async function handleIncomingCall(incomingCallId, callData) {
            if (peerConnection) return; // Already in a call
            
            callId = incomingCallId;
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('call-status-text').textContent = `Incoming ${callData.callType} call from ${callData.callerId.substring(0, 6)}...`;
            ringtone.play().catch(e => console.log("Ringtone error:", e));

            // Answer button add karein
            const answerBtn = document.createElement('button');
            answerBtn.textContent = 'Answer';
            answerBtn.className = 'square-btn';
            answerBtn.style.backgroundColor = 'green';
            answerBtn.onclick = () => answerCall(callData);
            document.getElementById('call-controls').appendChild(answerBtn);
            
            // Reject button
            const rejectBtn = document.createElement('button');
            rejectBtn.textContent = 'Reject';
            rejectBtn.className = 'square-btn';
            rejectBtn.style.backgroundColor = 'red';
            rejectBtn.onclick = () => endCall();
            document.getElementById('call-controls').appendChild(rejectBtn);
        }
        
        async function answerCall(callData) {
            ringtone.pause();
            document.getElementById('call-controls').innerHTML = document.getElementById('call-controls').innerHTML = `
                <button id="toggle-video-btn" class="square-btn" style="background-color: orange;">üìπ Toggle Video</button>
                <button id="toggle-audio-btn" class="square-btn" style="background-color: orange;">üéôÔ∏è Toggle Audio</button>
                <button id="end-call-btn" class="square-btn" style="background-color: red;">Hang Up üìû</button>
            `; // Controls reset karein
            document.getElementById('end-call-btn').addEventListener('click', endCall);

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: callData.callType === 'video', 
                    audio: true 
                });
                document.getElementById('local-video').srcObject = localStream;
                document.getElementById('local-video').style.display = callData.callType === 'video' ? 'block' : 'none';
                
                peerConnection = new RTCPeerConnection(configuration);
                setupPeerConnectionListeners();
                
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                
                // Offer set karein
                await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
                
                // Answer banao
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Answer ko database mein bhejo
                callsRef.child(callId).update({
                    answer: {
                        type: answer.type,
                        sdp: answer.sdp
                    }
                });
                
                // ICE candidates bhejna
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        callsRef.child(callId).child('candidates').child(currentUser.uid).push(event.candidate.toJSON());
                    }
                };
                
            } catch (error) {
                console.error("Error answering call:", error);
                alert("Could not answer call.");
                endCall();
            }
        }
        
        function listenForCallUpdates() {
             callsRef.child(callId).on('value', async (snapshot) => {
                const callData = snapshot.val();
                if (!callData) {
                    // Call ended by other party
                    endCall(); 
                    return;
                }
                
                // Answer receive karna
                if (callData.answer && peerConnection && peerConnection.localDescription.type === 'offer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.answer));
                    document.getElementById('call-status-text').textContent = "Connecting...";
                }
                
                // Remote ICE candidates add karna
                const remoteCandidatesRef = callsRef.child(callId).child('candidates').child(callData.callerId === currentUser.uid ? callData.recipientId : callData.callerId);
                remoteCandidatesRef.on('child_added', (candidateSnapshot) => {
                    const candidate = candidateSnapshot.val();
                    if (candidate && peerConnection) {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                            .catch(e => console.error("Error adding ICE candidate:", e));
                    }
                });
            });
        }


        // ***************************************************************
        // X. ADMIN PANEL LOGIC
        // ***************************************************************
        
        document.getElementById('admin-panel-btn').addEventListener('click', () => {
             if (isAdmin) {
                handleNavigation('admin-panel-view');
                loadAdminUsers();
                loadAdminPublicMessages();
             } else {
                 alert("Access Denied.");
             }
        });
        
        document.querySelector('.admin-panel-tabs').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.tab) {
                document.querySelectorAll('.admin-tab-content').forEach(tab => tab.style.display = 'none');
                document.querySelector('.admin-panel-tabs .active-tab')?.classList.remove('active-tab');
                
                document.getElementById(e.target.dataset.tab).style.display = 'block';
                e.target.classList.add('active-tab');
            }
        });
        
        function loadAdminUsers() {
            const list = document.getElementById('admin-users-list');
            list.innerHTML = '';
            
            usersRef.on('value', (snapshot) => {
                list.innerHTML = '';
                const users = snapshot.val();
                if (!users) return;
                
                Object.keys(users).forEach(uid => {
                    const user = users[uid];
                    const item = document.createElement('div');
                    item.className = 'chat-list-item';
                    item.innerHTML = `
                        <div>
                            <h3>${user.name} (${uid.substring(0, 6)}...)</h3>
                            <p>Email: ${user.email}</p>
                            <p>Status: ${user.isOnline ? 'Online (üü¢)' : `Offline (${new Date(user.lastSeen).toLocaleString()})`}</p>
                            <p>Role: <strong>${user.role || 'user'}</strong></p>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="changeUserRole('${uid}', 'admin')" class="square-btn" style="background-color: #ffc107; font-size: 0.8em;">Make Admin</button>
                            <button onclick="changeUserRole('${uid}', 'user')" class="square-btn" style="background-color: #6c757d; font-size: 0.8em;">Make User</button>
                            <button onclick="deleteUserAccount('${uid}')" class="square-btn" style="background-color: #dc3545; font-size: 0.8em;">Delete</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });
        }

        window.changeUserRole = (uid, role) => {
             if (!confirm(`Are you sure you want to change user ${uid.substring(0, 6)}'s role to ${role}?`)) return;
             usersRef.child(uid).update({ role: role })
                 .then(() => alert(`Role updated to ${role}.`))
                 .catch(e => alert("Error updating role: " + e.message));
        };
        
        // Note: deleteUserAccount function requires Firebase Admin SDK on a backend, 
        // which cannot be done from the frontend. This is a placeholder.
        window.deleteUserAccount = (uid) => {
             alert(`Account deletion for UID ${uid.substring(0, 6)} requires a secure backend (Firebase Admin SDK). Cannot perform from frontend code.`);
        };
        
        function loadAdminPublicMessages() {
            const list = document.getElementById('admin-public-messages');
            list.innerHTML = '';
            
            publicMessagesRef.limitToLast(30).on('child_added', (snapshot) => {
                const message = snapshot.val();
                const messageId = snapshot.key;
                const isOutgoing = message.senderId === currentUser?.uid;
                
                const card = createMessageCard(message, isOutgoing, messageId, true, true); // Admin View enabled
                list.appendChild(card);
                list.scrollTop = list.scrollHeight;
            });
        }

        window.deletePublicMessage = (messageId) => {
             if (!confirm("Are you sure you want to delete this public message?")) return;
             publicMessagesRef.child(messageId).remove()
                 .then(() => {
                     // Message ko UI se hatao
                     const element = document.querySelector(`.message-card[data-message-id='${messageId}']`);
                     if (element) element.remove();
                     alert("Message deleted successfully.");
                 })
                 .catch(e => alert("Error deleting message: " + e.message));
        };


        // ***************************************************************
        // XI. FINAL UI EVENT LISTENERS
        // ***************************************************************

        // Bottom Navigation (Sabse important)
        document.getElementById('bottom-nav').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.view) {
                if (currentUser || e.target.dataset.view === 'auth-view') {
                    handleNavigation(e.target.dataset.view);
                } else {
                    alert("Please sign in first!");
                    handleNavigation('auth-view');
                }
            }
        });
        
        // Theme Toggle
        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });
        
        // Friends View load listeners
        document.getElementById('bottom-nav').querySelector('button[data-view="friends-view"]').addEventListener('click', () => {
            if (currentUser) {
                loadFriendRequests();
                loadFriendsList();
            }
        });
        
        // Emoji Picker Logic
        const emojis = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üò≠', 'üò°', 'üôè', 'üíØ', 'üî•', 'üéâ', 'üí°'];
        const emojiPicker = document.getElementById('emoji-picker');
        emojis.forEach(emoji => {
            const btn = document.createElement('button');
            btn.textContent = emoji;
            btn.addEventListener('click', (e) => {
                const input = currentView === 'public-chat-view' ? document.getElementById('public-message-input') : document.getElementById('private-message-input');
                input.value += emoji;
                input.focus();
                emojiPicker.style.display = 'none';
            });
            emojiPicker.appendChild(btn);
        });

        document.getElementById('emoji-toggle-btn').addEventListener('click', () => {
            const isHidden = emojiPicker.style.display === 'none';
            emojiPicker.style.display = isHidden ? 'flex' : 'none';
        });

    </script>
</body>
</html>
