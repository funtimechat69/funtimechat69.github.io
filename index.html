<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>FunTimeChat ‚Äî MH</title>
  <meta name="theme-color" content="#9be7ff">
  <style>
    :root{
      --bg1:#9be7ff; --bg2:#ffc0e6; --card:#ffffff; --muted:#6b7280;
      --accent-start:#6ec6ff; --accent-end:#ff8ac6; --text:#042033;
      --owner-gold:#f6c24a; --vip-purple:#9b6eff; --admin-white:#ffffff;
      --success:#2ecc71; --danger:#ff6b6b; --radius:12px; font-family:Inter,system-ui,Arial,Helvetica,sans-serif;
      --max-w:980px;
    }
    [data-theme="dark"]{ --bg1:#071526; --bg2:#042033; --card:#071526; --muted:#9aa6b2; --text:#d6e6ee; --accent-start:#2b7fbf; --accent-end:#9b4fae; }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;color:var(--text);background:linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}
    body{font-size:15px}
    .app{max-width:var(--max-w);margin:10px auto;padding:8px}
    .card{background:var(--card);border-radius:16px;padding:12px;box-shadow:0 12px 40px rgba(0,0,0,.12);display:flex;flex-direction:column;gap:10px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .leftRow{display:flex;gap:12px;align-items:center}
    .menuBtn{width:44px;height:44px;border-radius:10px;background:#fff;border:1px solid #eee;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .logo{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--text);font-size:20px}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:13px}

    .layout{display:flex;gap:12px}
    .main{flex:2;display:flex;flex-direction:column;min-width:280px}
    .side{width:320px;min-width:220px;display:flex;flex-direction:column;gap:10px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid #eee;background:#fff;cursor:pointer}
    .messages{height:calc(60vh);overflow:auto;padding:12px;border-radius:12px;border:1px solid #eef7fb;background:linear-gradient(180deg,#fbfeff,#f7fcff)}
    .msgWrap{margin-bottom:12px}
    .meta{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .bubble{padding:10px 12px;border-radius:12px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.03);max-width:78%;word-break:break-word}
    .bubble.me{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#fff;margin-left:auto}
    .sendRow{display:flex;gap:8px;margin-top:10px;align-items:center}
    input[type="text"], textarea, select{flex:1;padding:10px;border-radius:10px;border:1px solid #e6f3fb;background:transparent;color:var(--text)}
    button.primary{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#022;cursor:pointer;font-weight:700}

    .usersBox{padding:8px;border-radius:10px;border:1px solid #f0f6fb;background:#fff;overflow:auto;max-height:260px}
    .userRow{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px}
    .userLeft{display:flex;align-items:center;gap:10px}
    .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#eafcff,#ffeaf5);display:flex;align-items:center;justify-content:center;font-weight:900;color:#033}
    .small{font-size:13px;color:var(--muted)}
    .sectionTitle{font-weight:800;margin-bottom:6px}
    .badge{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:12px;font-weight:800;color:#042033;font-size:12px;margin-left:8px;border:2px solid rgba(0,0,0,0.06)}
    .badge.owner{background:var(--owner-gold);color:#3b2f00}
    .badge.vip{background:var(--vip-purple);color:#fff}
    .badge.admin{background:var(--admin-white);color:#042033;border:1px solid #ddd}
    .onlineDot{width:10px;height:10px;border-radius:50%;background:var(--success);display:inline-block;margin-left:6px;border:2px solid rgba(255,255,255,0.8)}

    .menuPanel{position:fixed;left:12px;top:86px;width:320px;background:var(--card);border-radius:12px;padding:12px;box-shadow:0 20px 60px rgba(0,0,0,.12);display:none;z-index:99}
    .pmOverlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:60}
    .pmCard{width:92%;max-width:980px;background:var(--card);border-radius:10px;padding:12px;display:flex;gap:12px;flex-wrap:wrap}
    .pmLeft{flex:1;display:flex;flex-direction:column}
    .pmRight{width:320px;border-left:1px solid #eee;padding-left:10px}
    .pmMessages{flex:1;overflow:auto;padding:8px;border-radius:8px;background:#fbfdff;min-height:160px}
    .closeX{background:var(--danger);color:#fff;border-radius:8px;padding:6px 8px;border:none;cursor:pointer}

    .bottomNav{display:flex;justify-content:space-around;align-items:center;padding:8px;background:#fff;border-radius:12px;margin-top:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .navItem{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);cursor:pointer}
    .rulesModal{display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:120}
    .rulesContent{background:var(--card);padding:16px;border-radius:10px;max-width:720px;margin:40px auto;color:var(--text)}
    .videoSmall{width:180px;height:120px;border-radius:8px;position:absolute;right:18px;bottom:18px;z-index:80;border:2px solid #fff}
    video{width:100%;height:auto;border-radius:8px;background:#000}
    .delBtn{background:#fff;border:1px solid #f3c2c2;padding:6px 8px;border-radius:6px;cursor:pointer;margin-left:8px}

    .smallCenter{font-size:13px;text-align:center;color:var(--muted)}

    @media (max-width:980px){
      .layout{flex-direction:column}
      .side{width:100%}
      .messages{height:45vh}
      .menuPanel{left:8px;top:70px;width:90%}
      .pmRight{width:100%;border-left:none;padding-left:0;border-top:1px solid #eee;margin-top:8px}
      .pmCard{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card" id="mainCard">
      <div class="top">
        <div class="leftRow">
          <div class="menuBtn" id="menuToggle">‚ò∞</div>
          <div class="logo" id="logoText">MH</div>
          <div>
            <h1 id="siteTitle">FunTimeChat</h1>
            <div class="sub">Public ¬∑ Rooms ¬∑ Private PMs ¬∑ Calls</div>
          </div>
        </div>
        <div id="userArea"></div>
      </div>

      <div class="layout">
        <div class="main">
          <div class="toolbar">
            <button class="pill" id="btnPublic">Public Room</button>
            <button class="pill" id="btnMyRooms">My Rooms</button>
            <button class="pill" id="btnCreateRoom">Create Room</button>
            <button class="pill" id="btnMatch">Find Random</button>
            <div style="flex:1"></div>
            <div class="small">Current: <strong id="currentRoomLabel">room1 (Public)</strong></div>
          </div>

          <div id="messages" class="messages"></div>

          <div class="sendRow">
            <input id="msgInput" type="text" placeholder="Type message and press Send..." />
            <button id="sendBtn" class="primary">Send</button>
          </div>
          <div class="small" style="margin-top:8px">Messages saved under <code id="pathInfo">/chats/room1/messages</code></div>
        </div>

        <div class="side">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="sectionTitle">Rooms</div>
              <div class="small">Public & invite-only</div>
            </div>
            <div><button class="pill" id="btnRules">Rules</button></div>
          </div>

          <div>
            <div class="small" style="margin-bottom:6px">Create room</div>
            <div style="display:flex;gap:6px;margin-bottom:8px">
              <input id="newRoomName" placeholder="Room name" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee" />
              <select id="newRoomType" style="padding:8px;border-radius:8px;border:1px solid #eee">
                <option value="public">Public</option>
                <option value="invite">Invite-only</option>
              </select>
              <button class="pill" id="createRoomBtn">Create</button>
            </div>
          </div>

          <div style="font-weight:700;margin-bottom:6px">Available Rooms</div>
          <div id="roomsList" class="usersBox roomList"></div>

          <div style="font-weight:700;margin-top:12px;margin-bottom:6px">People</div>
          <div id="allUsers" class="usersBox"></div>

          <div style="font-weight:700;margin-top:12px;margin-bottom:6px">Friends</div>
          <div id="friendsList" class="usersBox"></div>

          <div style="font-weight:700;margin-top:12px;margin-bottom:6px">Friend Requests</div>
          <div id="friendReqs" class="usersBox small"></div>

          <div class="small" style="margin-top:8px">Status at <code>/status/{uid}</code> ‚Ä¢ Roles at <code>/roles/{uid}</code></div>

          <div class="bottomNav" style="margin-top:12px">
            <div class="navItem" id="navRooms">üè†<div class="small">Rooms</div></div>
            <div class="navItem" id="navMessages">üí¨<div class="small">Messages</div></div>
            <div class="navItem" id="navPeople">üë•<div class="small">People</div></div>
            <div class="navItem" id="navApps">üîß<div class="small">Apps</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Menu panel -->
  <div id="menuPanel" class="menuPanel">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
      <div class="avatar" id="menuAvatar">MH</div>
      <div>
        <div id="menuName" style="font-weight:800">Funtimechat</div>
        <div class="small" id="menuEmail">owner@example.com</div>
      </div>
    </div>

    <div style="margin-bottom:8px">
      <div style="font-weight:700">Profile</div>
      <div class="small" id="profileInfo">Name: (from Google) ‚Äî username cannot be changed</div>
      <div style="height:8px"></div>
      <label class="small">Upload profile photo</label>
      <input id="avatarFile" type="file" accept="image/*" />
      <div style="height:8px"></div>
      <button class="pill" id="themeToggle">Toggle Theme</button>
    </div>

    <div style="height:8px"></div>
    <div class="menuRow" id="mProfile">üë§ Profile</div>
    <div class="menuRow" id="mLogout">‚èèÔ∏è Logout</div>
    <div class="menuRow" id="mAbout">‚ÑπÔ∏è About</div>
    <div class="menuRow" id="mShare">üîó Share</div>
    <div class="menuRow" id="mSwitch">üîÅ Switch Accounts</div>
    <div style="height:8px"></div>

    <div style="margin-top:8px">
      <div style="font-weight:700">Quick admin (owner only)</div>
      <div class="small">Set role for UID:</div>
      <input id="adminUidInput" placeholder="uid to set role" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee;margin-top:6px" />
      <select id="roleSelect" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee;margin-top:6px">
        <option value="owner">owner</option>
        <option value="admin">admin</option>
        <option value="vip">vip</option>
        <option value="">clear</option>
      </select>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="pill" id="setRoleBtn">Set role</button>
        <button class="pill" id="revokeRoleBtn" style="background:#fff;border:1px solid #eee">Remove role</button>
      </div>
    </div>

    <div style="height:8px"></div>
    <div class="small" style="color:var(--muted)">Accept site rules to use ‚Äî required for chat (Rules)</div>
  </div>

  <!-- PM popup -->
  <div id="pmOverlay" class="pmOverlay">
    <div class="pmCard">
      <div class="pmLeft">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div id="pmTitle" style="font-weight:800">Private Chat</div>
            <div class="small" id="pmSub">Private chat</div>
          </div>
          <div><button id="pmClose" class="closeX">Close</button></div>
        </div>

        <div style="position:relative;margin-top:8px">
          <video id="remoteVideo" autoplay playsinline></video>
          <video id="localVideo" autoplay playsinline muted class="videoSmall"></video>
        </div>

        <div class="pmMessages" id="pmMessages"></div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="pmInput" type="text" placeholder="Type private message..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee" />
          <button id="pmSend" class="pill">Send</button>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnAudioCall" class="pill">Audio Call</button>
          <button id="btnVideoCall" class="pill">Video Call</button>
          <button id="btnHangUp" class="pill" style="background:#ffefef;border:1px solid var(--danger)">Hang Up</button>
        </div>
      </div>

      <div class="pmRight">
        <div style="font-weight:700;margin-bottom:8px">Profile</div>
        <div id="pmProfile" style="display:flex;gap:8px;align-items:center">
          <div class="avatar" id="pmAvatar">U</div>
          <div>
            <div id="pmName" style="font-weight:700">User</div>
            <div class="small" id="pmEmail">email</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <button id="pmAddFriend" class="pill">Add Friend</button>
          <div style="height:8px"></div>
          <button id="pmBlock" class="pill" style="background:#ffefef;border:1px solid var(--danger)">Block User</button>
          <div style="height:8px"></div>
          <div class="small">Private messages & calls signaling stored at <code>/private/{chatId}</code> and <code>/webrtc/{chatId}</code></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rules Modal -->
  <div id="rulesModal" class="rulesModal">
    <div class="rulesContent">
      <h3>FunTime Chat ‚Äî Community Guidelines (Please accept)</h3>
      <p>We want FunTime Chat to be friendly and fun. Soft rules (B): casual talk allowed but respectful.</p>
      <ul>
        <li><strong>Be respectful.</strong> No personal attacks or harassment.</li>
        <li><strong>No doxxing.</strong> Don't share private info of others.</li>
        <li><strong>No spam or scams.</strong></li>
        <li><strong>Explicit content:</strong> Keep private & consensual.</li>
        <li><strong>Report misuse.</strong> Use block/report; don't retaliate.</li>
      </ul>
      <div style="text-align:right;margin-top:10px">
        <button id="acceptRules" class="pill">Accept & Continue</button>
        <button id="closeRulesBtn" class="pill" style="background:#fff;border:1px solid #eee;margin-left:8px">Close</button>
      </div>
    </div>
  </div>

  <audio id="notifySound"><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQQAAAAA" type="audio/wav"></audio>

  <!-- Firebase SDK v9 modular -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import {
      getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged,
      signInAnonymously, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import {
      getDatabase, ref, set, push, onChildAdded, onValue, update, onDisconnect,
      serverTimestamp, get, child, remove
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

    // ---------- FIREBASE CONFIG (your project - you already set this earlier) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyB__tJ3sv3cB2N3vKHFCv8SYngJENQxwhY",
      authDomain: "funtimechat69-39947.firebaseapp.com",
      databaseURL: "https://funtimechat69-39947-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "funtimechat69-39947",
      storageBucket: "funtimechat69-39947.firebasestorage.app",
      messagingSenderId: "559638056734",
      appId: "1:559638056734:web:9329d2b561b6fab106830f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // UI refs
    const userArea = document.getElementById('userArea');
    const messagesEl = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const allUsersEl = document.getElementById('allUsers');
    const friendsListEl = document.getElementById('friendsList');
    const friendReqsEl = document.getElementById('friendReqs');
    const pmOverlay = document.getElementById('pmOverlay');
    const pmMessages = document.getElementById('pmMessages');
    const pmInput = document.getElementById('pmInput');
    const pmSend = document.getElementById('pmSend');
    const pmClose = document.getElementById('pmClose');
    const pmAvatar = document.getElementById('pmAvatar');
    const pmName = document.getElementById('pmName');
    const pmEmail = document.getElementById('pmEmail');
    const pmAddFriend = document.getElementById('pmAddFriend');
    const pmBlock = document.getElementById('pmBlock');
    const notifySound = document.getElementById('notifySound');
    const btnMatch = document.getElementById('btnMatch');
    const btnRules = document.getElementById('btnRules');
    const rulesModal = document.getElementById('rulesModal');
    const acceptRules = document.getElementById('acceptRules');
    const closeRulesBtn = document.getElementById('closeRulesBtn');
    const menuToggle = document.getElementById('menuToggle');
    const menuPanel = document.getElementById('menuPanel');
    const menuName = document.getElementById('menuName');
    const menuEmail = document.getElementById('menuEmail');
    const menuAvatar = document.getElementById('menuAvatar');
    const roomsList = document.getElementById('roomsList');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const newRoomName = document.getElementById('newRoomName');
    const newRoomType = document.getElementById('newRoomType');
    const currentRoomLabel = document.getElementById('currentRoomLabel');
    const pathInfo = document.getElementById('pathInfo');
    const avatarFile = document.getElementById('avatarFile');
    const themeToggle = document.getElementById('themeToggle');
    const adminUidInput = document.getElementById('adminUidInput');
    const roleSelect = document.getElementById('roleSelect');
    const setRoleBtn = document.getElementById('setRoleBtn');
    const revokeRoleBtn = document.getElementById('revokeRoleBtn');

    // helpers
    function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function show(el){ el.style.display = 'flex' }
    function hide(el){ el.style.display = 'none' }

    // state
    let currentUser = null;
    let currentRoom = 'room1';
    let acceptedRules = false;
    let currentPmOtherUid = null;
    let currentPmChatId = null;

    // Authentication UI rendering + methods (Google, Email, Anonymous)
    function renderUserUI(user){
      if(!user){
        userArea.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
          <button class="pill" id="loginBtn">Sign in with Google</button>
          <button class="pill" id="guestBtn">Guest</button>
          </div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="emailIn" placeholder="email" style="padding:6px;border-radius:6px;border:1px solid #eee" />
            <input id="passIn" placeholder="password" type="password" style="padding:6px;border-radius:6px;border:1px solid #eee" />
            <button class="pill" id="emailSignup">Sign up</button>
            <button class="pill" id="emailLogin">Login</button>
          </div>`;
        document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider).catch(e=>alert(e.message));
        document.getElementById('guestBtn').onclick = () => signInAnonymously(auth).catch(e=>alert(e.message));
        document.getElementById('emailSignup').onclick = async ()=>{
          const em = document.getElementById('emailIn').value.trim();
          const pw = document.getElementById('passIn').value;
          if(!em || !pw) return alert('Enter email & password');
          try{
            const cred = await createUserWithEmailAndPassword(auth, em, pw);
            await sendEmailVerification(cred.user);
            alert('Account created ‚Äî check email to verify.');
          }catch(e){ alert(e.message); }
        };
        document.getElementById('emailLogin').onclick = async ()=>{
          const em = document.getElementById('emailIn').value.trim();
          const pw = document.getElementById('passIn').value;
          if(!em || !pw) return alert('Enter email & password');
          try{
            await signInWithEmailAndPassword(auth, em, pw);
          }catch(e){ alert(e.message); }
        };

        menuName.innerText = 'Guest'; menuEmail.innerText=''; menuAvatar.innerText='MH';
        document.getElementById('profileInfo').innerText='Name: not signed (username cannot be changed)';
      } else {
        const display = esc(user.displayName||user.email||'User');
        userArea.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
          <div style="text-align:right">
            <div style="font-weight:800">${display}</div>
            <div class="small">${esc(user.email||'')}</div>
          </div>
          <button class="pill" id="logoutBtn">Logout</button>
        </div>`;
        document.getElementById('logoutBtn').onclick = () => signOut(auth);
        menuName.innerText = user.displayName || user.email || 'User';
        menuEmail.innerText = user.email || '';
        menuAvatar.innerText = (user.displayName||'MH').split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase();
        document.getElementById('profileInfo').innerText = `Name: ${user.displayName || user.email || ''} (username cannot be changed)`;
      }
    }

    // save user + presence + auto-owner
    async function saveUser(user){
      if(!user) return;
      const uRef = ref(db, 'users/' + user.uid);
      const existing = await get(uRef);
      const data = { name:user.displayName||null, email:user.email||null, photoURL:user.photoURL||null, createdAt:serverTimestamp() };
      if(existing.exists() && existing.val().avatarData) data.avatarData = existing.val().avatarData;
      await set(uRef, data);

      // presence
      const conRef = ref(db, '.info/connected');
      const statusRef = ref(db, 'status/' + user.uid);
      onValue(conRef, snap => {
        if(snap.val() === true){
          set(statusRef, { state:'online', last_changed:serverTimestamp() });
          onDisconnect(statusRef).set({ state:'offline', last_changed:serverTimestamp() });
        } else {
          set(statusRef, { state:'offline', last_changed:serverTimestamp() });
        }
      });

      // auto-set owner if none exists
      const rolesRoot = await get(ref(db,'roles'));
      if(!rolesRoot.exists()){
        // no roles at all -> set this user as owner
        await set(ref(db, `roles/${user.uid}`), 'owner');
        console.log('No roles existed, auto-set current user as owner:', user.uid);
      } else {
        // if there's no owner among roles, set first signed-in user as owner
        const roles = rolesRoot.val();
        const hasOwner = Object.values(roles).some(r=>r==='owner');
        if(!hasOwner){
          await set(ref(db, `roles/${user.uid}`), 'owner');
          console.log('No owner found in roles, auto-set current user as owner:', user.uid);
        }
      }
    }

    // auth listener
    onAuthStateChanged(auth, async user=>{
      currentUser = user;
      renderUserUI(user);
      if(user){
        await saveUser(user);
        loadRooms(); loadUsers(); loadFriendRequests(); loadFriends();
      } else {
        loadRooms(); loadUsers();
      }
    });

    // rules modal
    btnRules.onclick = ()=> rulesModal.style.display = 'flex';
    closeRulesBtn.onclick = ()=> rulesModal.style.display = 'none';
    acceptRules.onclick = ()=> { acceptedRules = true; rulesModal.style.display='none'; alert('Thanks ‚Äî you can now chat.'); };

    // menu & theme
    menuToggle.onclick = ()=> menuPanel.style.display = menuPanel.style.display === 'block' ? 'none' : 'block';
    themeToggle.onclick = ()=> { const cur = document.documentElement.getAttribute('data-theme'); if(cur==='dark') document.documentElement.removeAttribute('data-theme'); else document.documentElement.setAttribute('data-theme','dark'); };
    document.body.addEventListener('click', (e)=>{ if(!menuPanel.contains(e.target) && e.target !== menuToggle) menuPanel.style.display = 'none'; });

    // avatar upload stored as dataURL
    avatarFile.addEventListener('change', async (e)=>{
      if(!currentUser) return alert('Sign in first');
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = async ()=> { const dataUrl = reader.result; await set(ref(db, `users/${currentUser.uid}/avatarData`), dataUrl); alert('Profile photo uploaded.'); loadUsers(); };
      reader.readAsDataURL(file);
    });

    // ROOM messaging
    function setRoom(roomId, metaLabel){
      if(!acceptedRules){ rulesModal.style.display='flex'; return; }
      currentRoom = roomId; currentRoomLabel.innerText = metaLabel || roomId;
      pathInfo.innerText = currentRoom.startsWith('room') ? `/chats/${currentRoom}/messages` : `/rooms/${currentRoom}/messages`;
      messagesEl.innerHTML = '';
      const node = currentRoom.startsWith('room') ? ref(db, `chats/${currentRoom}/messages`) : ref(db, `rooms/${currentRoom}/messages`);
      onChildAdded(node, snap=> {
        const m = snap.val(); if(!m) return;
        const key = snap.key;
        if(currentUser && m.uid){ get(ref(db, `blocks/${currentUser.uid}/${m.uid}`)).then(bsnap=>{ if(bsnap.exists() && bsnap.val()===true) return; appendMessageToUI(m,key); }); }
        else appendMessageToUI(m,key);
      });
    }

    async function appendMessageToUI(m,key){
      const wrap = document.createElement('div'); wrap.className='msgWrap'; wrap.dataset.key = key;
      const meta = document.createElement('div'); meta.className='meta'; meta.innerText = `${esc(m.name||'Anon')} ‚Ä¢ ${new Date((m.ts && m.ts.toString && m.ts.toString().length>10)?m.ts:Date.now()).toLocaleTimeString()}`;
      // role badge
      const roleSnap = await get(ref(db, `roles/${m.uid}`));
      if(roleSnap.exists()){
        const role = roleSnap.val();
        const s = document.createElement('span');
        s.style.marginLeft='8px';
        if(role==='owner'){s.className='badge owner';s.innerText='O'}
        else if(role==='vip'){s.className='badge vip';s.innerText='V'}
        else if(role==='admin'){s.className='badge admin';s.innerText='A'}
        meta.appendChild(s);
      }
      // online dot
      const statusSnap = await get(ref(db, `status/${m.uid}`));
      if(statusSnap.exists() && statusSnap.val().state==='online'){ const dot=document.createElement('span'); dot.className='onlineDot'; meta.appendChild(dot); }

      const bubble = document.createElement('div'); bubble.className='bubble' + ((currentUser && m.uid===currentUser.uid)?' me':''); bubble.innerText = m.text || '';
      if(currentUser && m.uid===currentUser.uid){
        const dBtn=document.createElement('button'); dBtn.className='delBtn'; dBtn.innerText='Delete'; dBtn.onclick = async ()=>{ if(!confirm('Delete your message?')) return; await remove(ref(db, `${currentRoom.startsWith('room')?`chats/${currentRoom}/messages/${key}`:`rooms/${currentRoom}/messages/${key}`}`)); wrap.remove(); };
        meta.appendChild(dBtn);
      }
      wrap.appendChild(meta); wrap.appendChild(bubble); messagesEl.appendChild(wrap); messagesEl.scrollTop = messagesEl.scrollHeight; try{ notifySound.play().catch(()=>{}); }catch(e){}
    }

    // send message
    sendBtn.onclick = async ()=>{ const txt=msgInput.value.trim(); if(!txt) return; if(!currentUser) return alert('Sign in first'); const path = currentRoom.startsWith('room') ? `chats/${currentRoom}/messages` : `rooms/${currentRoom}/messages`; const p = push(ref(db, path)); await set(p, { uid: currentUser.uid, name: currentUser.displayName || currentUser.email || 'User', text: txt, ts: serverTimestamp() }); msgInput.value=''; };
    msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendBtn.click(); });

    // ensure welcome message + init
    (async function ensureWelcome(){ const s = await get(ref(db, `chats/room1/messages`)); if(!s.exists()){ const p = push(ref(db, `chats/room1/messages`)); await set(p, { uid:'system', name:'System', text:'Welcome to FunTimeChat ‚Äî room1 public', ts: serverTimestamp() }); } setRoom('room1','room1 (Public)'); })();

    // rooms CRUD
    createRoomBtn.onclick = ()=> createRoom(newRoomName.value, newRoomType.value);
    async function createRoom(name,type){ if(!currentUser) return alert('Sign in first'); if(!name||!name.trim()) return alert('Enter room name'); const id = name.trim().toLowerCase().replace(/\s+/g,'_') + '_' + Date.now().toString(36); await set(ref(db, `rooms/${id}/meta`), { name:name.trim(), owner:currentUser.uid, type, createdAt:serverTimestamp() }); await set(ref(db, `rooms/${id}/members/${currentUser.uid}`), true); newRoomName.value=''; loadRooms(); }
    async function loadRooms(){ const snap = await get(ref(db,'rooms')); const obj = snap.val()||{}; roomsList.innerHTML=''; Object.keys(obj).forEach(id=>{ const m=obj[id].meta||{}; const row=document.createElement('div'); row.className='userRow'; row.innerHTML=`<div style="display:flex;flex-direction:column"><div style="font-weight:700">${esc(m.name||id)}</div><div class="small">${esc(m.type||'public')}</div></div><div><button class="pill joinBtn">Join</button></div>`; roomsList.appendChild(row); row.querySelector('.joinBtn').onclick = async ()=>{ if(m.type==='invite'){ const allowed = await get(child(ref(db), `rooms/${id}/members/${currentUser?currentUser.uid:'nogu'}`)); if(!allowed.exists()) return alert('Invite-only room. Ask owner to add you.'); } setRoom(id, m.name||id); }; }); }

    // users/friends/block
    async function loadUsers(){ const s = await get(ref(db,'users')); const u = s.val()||{}; renderUsersList(u); }
    function renderUsersList(usersObj){ allUsersEl.innerHTML=''; Object.keys(usersObj).forEach(async uid=>{
      const u=usersObj[uid]; const row=document.createElement('div'); row.className='userRow';
      const left=document.createElement('div'); left.className='userLeft';
      const av=document.createElement('div'); av.className='avatar'; av.innerText=(u.name||'U').split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase();
      const aSnap = await get(ref(db, `users/${uid}/avatarData`));
      if(aSnap.exists()){ const img=document.createElement('img'); img.src=aSnap.val(); img.style.width='44px'; img.style.height='44px'; img.style.borderRadius='50%'; av.innerHTML=''; av.appendChild(img); }
      const info=document.createElement('div'); info.style.display='flex'; info.style.flexDirection='column'; info.innerHTML=`<div style="font-weight:700">${esc(u.name||'Anon')}</div><div class="small">${esc(u.email||'')}</div>`;
      left.appendChild(av); left.appendChild(info);
      const right=document.createElement('div');
      const pmBtn=document.createElement('button'); pmBtn.className='pill'; pmBtn.innerText='PM'; pmBtn.onclick=()=> openPmWith(uid,u);
      const addBtn=document.createElement('button'); addBtn.className='pill'; addBtn.innerText='Add'; addBtn.onclick=async ()=>{ if(!currentUser) return alert('Sign in first'); await set(ref(db, `friendRequests/${uid}/${currentUser.uid}`), { from: currentUser.uid, ts: serverTimestamp() }); alert('Friend request sent'); };
      const blockBtn=document.createElement('button'); blockBtn.className='pill'; blockBtn.innerText='Block'; blockBtn.onclick=async ()=>{ if(!currentUser) return alert('Sign in first'); await set(ref(db, `blocks/${currentUser.uid}/${uid}`), true); alert('Blocked'); };
      const badgeHolder=document.createElement('span');
      const rSnap = await get(ref(db, `roles/${uid}`));
      if(rSnap.exists()){ const role=rSnap.val(); const b=document.createElement('span'); b.className='badge ' + (role==='owner'?'owner':role==='vip'?'vip':'admin'); b.innerText = role==='owner'?'O':role==='vip'?'V':'A'; badgeHolder.appendChild(b); }
      const sSnap = await get(ref(db, `status/${uid}`));
      if(sSnap.exists() && sSnap.val().state==='online'){ const dot=document.createElement('span'); dot.className='onlineDot'; badgeHolder.appendChild(dot); }
      right.appendChild(pmBtn); right.appendChild(addBtn); right.appendChild(blockBtn); right.appendChild(badgeHolder);
      row.appendChild(left); row.appendChild(right); allUsersEl.appendChild(row);
    }); }

    // friend requests
    async function loadFriendRequests(){ if(!currentUser) return; const snap = await get(ref(db, `friendRequests/${currentUser.uid}`)); const obj = snap.val()||{}; friendReqsEl.innerHTML=''; Object.keys(obj).forEach(fromUid=>{ const el=document.createElement('div'); el.className='userRow'; el.innerHTML=`<div style="display:flex;flex-direction:column"><div style="font-weight:700">${esc(obj[fromUid].from)}</div><div class="small">Request</div></div>`; const accept=document.createElement('button'); accept.className='pill'; accept.innerText='Accept'; accept.onclick=async ()=>{ await set(ref(db, `friends/${currentUser.uid}/${fromUid}`), true); await set(ref(db, `friends/${fromUid}/${currentUser.uid}`), true); await remove(ref(db, `friendRequests/${currentUser.uid}/${fromUid}`)); loadFriendRequests(); loadFriends(); }; const decline=document.createElement('button'); decline.className='pill'; decline.innerText='Decline'; decline.onclick=async ()=>{ await remove(ref(db, `friendRequests/${currentUser.uid}/${fromUid}`)); loadFriendRequests(); }; el.appendChild(accept); el.appendChild(decline); friendReqsEl.appendChild(el); }); }

    // friends
    async function loadFriends(){ if(!currentUser) return; const snap = await get(ref(db, `friends/${currentUser.uid}`)); const obj = snap.val()||{}; friendsListEl.innerHTML=''; Object.keys(obj||{}).forEach(uid=>{ const el=document.createElement('div'); el.className='userRow'; el.innerHTML=`<div style="font-weight:700">${esc(uid)}</div><div><button class="pill">PM</button></div>`; el.querySelector('button').onclick = async ()=>{ const uSnap = await get(ref(db, `users/${uid}`)); openPmWith(uid, uSnap.val()||{}); }; friendsListEl.appendChild(el); }); }

    // PM / private chat
    function openPmWith(uid,userObj){
      if(!currentUser) return alert('Sign in first');
      (async ()=>{
        const snap = await get(ref(db, `friends/${currentUser.uid}/${uid}`));
        if(!snap.exists()){
          if(!confirm('You are not friends. Send friend request?')) return;
          await set(ref(db, `friendRequests/${uid}/${currentUser.uid}`), { from: currentUser.uid, ts: serverTimestamp() });
          alert('Friend request sent'); return;
        }
        currentPmOtherUid = uid;
        const ids=[currentUser.uid, uid].sort();
        currentPmChatId = `pm_${ids[0]}_${ids[1]}`;
        pmOverlay.style.display='flex';
        document.getElementById('pmTitle').innerText = `Chat with ${userObj.name||uid}`;
        pmName.innerText = userObj.name||uid;
        pmEmail.innerText = userObj.email||'';
        const aSnap = await get(ref(db, `users/${uid}/avatarData`));
        if(aSnap.exists()){ pmAvatar.innerHTML=''; const im=document.createElement('img'); im.src=aSnap.val(); im.style.width='44px'; im.style.height='44px'; im.style.borderRadius='50%'; pmAvatar.appendChild(im);} else pmAvatar.innerText=(userObj.name||'U').split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase();
        pmMessages.innerHTML='';
        const node = ref(db, `private/${currentPmChatId}/messages`);
        onChildAdded(node, snap=>{
          const m = snap.val(); if(!m) return;
          const div=document.createElement('div'); div.style.marginBottom='8px';
          const who=document.createElement('div'); who.className='small'; who.innerText = `${m.name || 'Anon'} ‚Ä¢ ${new Date(m.ts||Date.now()).toLocaleTimeString()}`;
          const b=document.createElement('div'); b.className='bubble' + ((currentUser && m.uid === currentUser.uid)?' me':''); b.innerText = m.text;
          if(currentUser && m.uid===currentUser.uid){ const del=document.createElement('button'); del.className='delBtn'; del.innerText='Delete'; del.onclick=async ()=>{ if(!confirm('Delete your message?')) return; await remove(ref(db, `private/${currentPmChatId}/messages/${snap.key}`)); div.remove(); }; who.appendChild(del); }
          div.appendChild(who); div.appendChild(b); pmMessages.appendChild(div); pmMessages.scrollTop = pmMessages.scrollHeight;
        });
      })();
    }

    pmSend.onclick = async ()=>{ if(!currentUser) return alert('Sign in first'); if(!currentPmChatId) return alert('Open PM first'); const t=pmInput.value.trim(); if(!t) return; const p=push(ref(db, `private/${currentPmChatId}/messages`)); await set(p, { uid:currentUser.uid, name:currentUser.displayName || currentUser.email, text:t, ts: serverTimestamp() }); pmInput.value=''; };
    pmClose.onclick = ()=>{ pmOverlay.style.display='none'; currentPmChatId=null; currentPmOtherUid=null; pmMessages.innerHTML=''; stopCall(); };
    pmAddFriend.onclick = async ()=>{ if(!currentUser||!currentPmOtherUid) return alert('Sign in and open PM'); await set(ref(db, `friendRequests/${currentPmOtherUid}/${currentUser.uid}`), { from: currentUser.uid, ts: serverTimestamp() }); alert('Friend request sent'); };
    pmBlock.onclick = async ()=>{ if(!currentUser||!currentPmOtherUid) return alert('Sign in and open PM'); await set(ref(db, `blocks/${currentUser.uid}/${currentPmOtherUid}`), true); alert('Blocked user'); };

    // WebRTC simple signalling
    let pc=null, localStream=null, remoteStream=null, signalingRef=null;
    const rtcConfig = { iceServers:[{urls:'stun:stun.l.google.com:19302'}] };

    async function startCall(kind){
      if(!currentUser || !currentPmChatId) return alert('Open PM first and sign in');
      try{ localStream = await navigator.mediaDevices.getUserMedia(kind==='video'?{video:true,audio:true}:{audio:true}); localVideo.srcObject = localStream; }catch(e){ return alert('Camera/Mic access denied: '+e.message); }
      pc = new RTCPeerConnection(rtcConfig);
      remoteStream = new MediaStream(); remoteVideo.srcObject = remoteStream;
      localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
      pc.ontrack = ev => { ev.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t)); };
      pc.onicecandidate = ev => { if(ev.candidate) push(signalingRef, { type:'candidate', candidate:ev.candidate.toJSON(), from:currentUser.uid }); };
      signalingRef = ref(db, `webrtc/${currentPmChatId}`);
      onChildAdded(signalingRef, async snap=>{ const data=snap.val(); if(!data) return; if(data.from===currentUser.uid) return; if(data.type==='offer'){ await pc.setRemoteDescription(data.desc); const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); await push(signalingRef, { type:'answer', desc:pc.localDescription, from:currentUser.uid }); } else if(data.type==='answer'){ await pc.setRemoteDescription(data.desc); } else if(data.type==='candidate'){ try{ await pc.addIceCandidate(data.candidate); }catch(e){ console.warn('ICE failed',e); } } else if(data.type==='hangup'){ alert('Call ended by other user'); stopCall(); } });
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await push(signalingRef, { type:'offer', desc:pc.localDescription, from:currentUser.uid });
      document.getElementById('pmSub').innerText = `Calling (${kind}) ‚Äî /webrtc/${currentPmChatId}`;
    }

    async function stopCall(){
      try{ if(pc){ pc.close(); pc=null; } if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; localVideo.srcObject=null; } if(remoteStream){ remoteStream.getTracks().forEach(t=>t.stop()); remoteStream=null; remoteVideo.srcObject=null; } if(signalingRef) await push(signalingRef, { type:'hangup', from: currentUser?currentUser.uid:'anon' }); }catch(e){ console.warn(e); }
      document.getElementById('pmSub').innerText = `Private chat: ${currentPmChatId}`;
    }

    document.getElementById('btnAudioCall').onclick = ()=> startCall('audio');
    document.getElementById('btnVideoCall').onclick = ()=> startCall('video');
    document.getElementById('btnHangUp').onclick = ()=> stopCall();

    // misc UI bindings
    document.getElementById('btnPublic').onclick = ()=> setRoom('room1','room1 (Public)');
    document.getElementById('btnMyRooms').onclick = ()=> setRoom(currentRoom, currentRoomLabel.innerText);
    document.getElementById('btnCreateRoom').onclick = ()=> newRoomName.focus();
    btnMatch.onclick = async ()=>{ const s = await get(ref(db,'rooms')); const obj = s.val()||{}; const keys = Object.keys(obj).filter(k=> (obj[k].meta && obj[k].meta.type==='public')); if(keys.length) setRoom(keys[Math.floor(Math.random()*keys.length)], (obj[keys[0]] && obj[keys[0]].meta && obj[keys[0]].meta.name) || keys[0]); else alert('No public rooms yet.'); };

    // initial load
    loadRooms(); loadUsers();

    // Admin quick set/remove role (only owner allowed)
    setRoleBtn.onclick = async ()=>{
      if(!currentUser) return alert('Sign in first');
      const myRoleSnap = await get(ref(db, `roles/${currentUser.uid}`));
      if(!myRoleSnap.exists() || myRoleSnap.val()!=='owner') return alert('Only owner can set roles.');
      const target = adminUidInput.value.trim();
      const role = roleSelect.value;
      if(!target) return alert('Enter uid to set');
      if(role) { await set(ref(db, `roles/${target}`), role); alert('Role set.'); } else { await remove(ref(db, `roles/${target}`)); alert('Role removed.'); }
      loadUsers();
    };
    revokeRoleBtn.onclick = async ()=>{ adminUidInput.value=''; roleSelect.value=''; alert('Choose role and uid then Set role to make changes.'); };

    // helper for console: setRole(uid,role) - owner only
    window.setRole = async (uid,role)=>{ const myRoleSnap = await get(ref(db, `roles/${auth.currentUser.uid}`)); if(!myRoleSnap.exists() || myRoleSnap.val()!=='owner') return alert('Only owner can set roles'); await set(ref(db, `roles/${uid}`), role); alert('Role set'); };

    console.log('FunTimeChat final script loaded with Google + Email + Anonymous auth');
  </script>
</body>
</html>
